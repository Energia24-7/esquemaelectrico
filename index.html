<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Diseño de Tableros Eléctricos</title>
  <style>
    body { display:flex; flex-direction:column; margin:0; font-family:sans-serif; height:100vh; }
    main { flex:1; display:flex; overflow-x:auto; } /* scroll horizontal en PC */
    #sidebar { width:300px; background:#f4f4f4; padding:10px; border-right:1px solid #ccc; overflow-y:auto; flex-shrink:0; }
    #canvas-container { flex:1; position:relative; min-width:600px; }
    #c { border:1px solid #ccc; background-color:white; }
    #zoomControls {
      position:absolute; top:10px; right:10px;
      background:#fff; border:1px solid #ccc; border-radius:5px;
      padding:5px; display:flex; gap:5px; z-index:10;
    }
    button, select, input { padding:5px; margin:3px 0; width:100%; box-sizing:border-box; }
    .error { color:red; font-weight:bold; margin-top:5px; }

    /* Panel derecho */
    #rightPanel {
      width:250px; background:#fafafa; border-left:1px solid #ccc;
      padding:10px; overflow-y:auto; display:none;
      flex-shrink:0;
    }
    #rightPanel.show { display:block; }

    /* Toggle */
    #togglePanel {
      position:fixed; top:100px; right:0; z-index:20;
      background:#007bff; color:#fff; border:none;
      border-radius:4px 0 0 4px;
      cursor:pointer; padding:5px; width:24px; height:100px;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-weight:bold;
    }

    /* Modal */
    #bomModal, #ofertaModal {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center;
      z-index:30;
    }
    #bomContent, #ofertaContent {
      background:#fff; padding:20px; border-radius:8px; max-width:700px; width:95%; max-height:90%; overflow-y:auto;
    }
    table { border-collapse:collapse; width:100%; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:5px; text-align:left; }
    tfoot td { font-weight:bold; }

    /* Responsive */
    @media(max-width:768px){
      main { flex-direction:column; }
      #sidebar { width:100%; border-right:none; border-bottom:1px solid #ccc; }
      #canvas-container { min-width:100%; }
      #c { width:100% !important; height:auto !important; }
      #rightPanel { width:100%; border-left:none; border-top:1px solid #ccc; }
      #togglePanel { top:auto; bottom:40px; height:30px; width:100px; writing-mode:horizontal-tb; border-radius:4px 4px 0 0; }
    }

    footer {
      background:#f4f4f4; text-align:center; padding:5px;
      border-top:1px solid #ccc; font-size:12px;
    }
  </style>
</head>
<body>
  <main>
    <div id="sidebar">
      <h3>Catálogo Eléctrico</h3>
      <label>Tipo</label>
      <select id="tipo"><option value="">-- Seleccionar --</option></select>
      <div id="config"></div>
      <button id="btnInsert">Insertar</button>
      <div id="msg" class="error"></div>
    </div>

    <div id="canvas-container">
      <canvas id="c" width="1200" height="800"></canvas>
      <div id="zoomControls">
        <button id="zoomIn">+</button>
        <button id="zoomOut">-</button>
        <button id="resetZoom">100%</button>
      </div>
    </div>

    <div id="rightPanel">
      <h3>Materiales Insertados</h3>
      <ul id="bomList"></ul>
      <button id="bomButton">Ver Detalle</button>
    </div>
  </main>
  <button id="togglePanel">TOTAL</button>

  <!-- Modal Detalle -->
  <div id="bomModal">
    <div id="bomContent">
      <h2>Detalle de Materiales</h2>
      <table id="bomTable">
        <thead>
          <tr><th>Part</th><th>Características</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="4">TOTAL</td><td id="totalCell">0</td></tr>
        </tfoot>
      </table>
      <button id="crearOferta">Crear oferta?</button>
      <button onclick="exportDetalle()">Exportar a Excel (CSV)</button>
      <button onclick="document.getElementById('bomModal').style.display='none'">Cerrar</button>
    </div>
  </div>

  <!-- Modal Oferta -->
  <div id="ofertaModal">
    <div id="ofertaContent">
      <h2>Datos del Cliente</h2>
      <label>Nombre</label><input id="cliNombre">
      <label>Contacto</label><input id="cliContacto">
      <label>Correo</label><input id="cliCorreo">
      <label>Teléfono</label><input id="cliTelefono">
      <label>Referencia</label><input id="cliRef">
      <br><br>
      <button onclick="generarPDF()">Generar PDF</button>
      <button onclick="document.getElementById('ofertaModal').style.display='none'">Cancelar</button>
    </div>
  </div>

  <footer>
    Copyright 2025 - Andrés Cuadrado - 0998879869 - Quito - Ecuador
  </footer>

  <!-- Librerías -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const canvas=new fabric.Canvas('c',{selection:true});
    let catalogo={},seleccion=null,bomData={};

    // GRID
    function drawGrid(){const g=50,w=canvas.getWidth(),h=canvas.getHeight(),l=[];for(let i=0;i<w/g;i++)l.push(new fabric.Line([i*g,0,i*g,h],{stroke:'#eee',selectable:false,evented:false}));for(let j=0;j<h/g;j++)l.push(new fabric.Line([0,j*g,w,j*g],{stroke:'#eee',selectable:false,evented:false}));const grid=new fabric.Group(l,{selectable:false,evented:false});canvas.add(grid);grid.sendToBack();}
    drawGrid();

    // ZOOM
    let zoomLevel=1;
    function setZoom(z){zoomLevel=z;canvas.setZoom(z);canvas.renderAll();}
    document.getElementById("zoomIn").onclick=()=>setZoom(zoomLevel*1.2);
    document.getElementById("zoomOut").onclick=()=>setZoom(zoomLevel/1.2);
    document.getElementById("resetZoom").onclick=()=>setZoom(1);

    // Canvas responsivo
    function resizeCanvas(){const container=document.getElementById("canvas-container");const w=container.clientWidth;const h=window.innerHeight*0.6;canvas.setWidth(w);canvas.setHeight(h);canvas.renderAll();}
    window.addEventListener("resize",resizeCanvas);
    resizeCanvas();

    // CSV
    const sheetUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2Bqb-E25bu5MSBfQ-Kdea4O_Xs3DiUbc03OBAa_O66zkMfkOztfqs9KnSRU47FR0TLvFlqV9E6eyx/pub?output=csv"; // reemplaza
    Papa.parse(sheetUrl,{download:true,header:true,complete:r=>{catalogo=procesar(r.data);llenarTipos();}});
    function procesar(data){const o={};data.forEach(row=>{if(!row.tipo)return;const t=row.tipo.toLowerCase();if(!o[t])o[t]=[];o[t].push({...row});});return o;}
    function llenarTipos(){const sel=document.getElementById("tipo");Object.keys(catalogo).forEach(t=>{sel.innerHTML+=`<option value="${t}">${t}</option>`;});}

    // Config
    const tipoSelect=document.getElementById("tipo"),configDiv=document.getElementById("config"),msgDiv=document.getElementById("msg");
    tipoSelect.addEventListener("change",()=>{configDiv.innerHTML="";msgDiv.innerText="";seleccion=null;if(tipoSelect.value)genCampos(tipoSelect.value);});
    function genCampos(tipo){
      const opciones=catalogo[tipo];if(!opciones)return;
      let html=`<label>Part Number</label><select id="partSel"><option value="">-- Elegir --</option>`;
      opciones.forEach(opt=>{html+=`<option value="${opt.part}">${opt.part}</option>`;});html+=`</select>`;
      const props=Object.keys(opciones[0]).filter(k=>!["part","icon","tipo"].includes(k));
      props.forEach(p=>{html+=`<label>${p}</label><select id="${p}Sel"><option value="">--</option>`;[...new Set(opciones.map(o=>o[p]))].forEach(v=>{html+=`<option value="${v}">${v}</option>`;});html+=`</select>`;});
      configDiv.innerHTML=html;
      const partSel=document.getElementById("partSel");
      partSel.addEventListener("change",()=>{const v=partSel.value;if(v){seleccion=opciones.find(o=>o.part===v);props.forEach(p=>document.getElementById(p+"Sel").value=seleccion[p]||"");msgDiv.innerText="";}});
    }

    // Insertar íconos
    function loadImage(src){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin="anonymous";i.onload=()=>res(i);i.onerror=()=>rej();i.src=src;});}
    document.getElementById("btnInsert").addEventListener("click",async()=>{if(!seleccion)return alert("Seleccione un componente válido.");const url=(seleccion.icon||"").trim();if(!url)return alert("No hay icono.");try{const img=await loadImage(url);const f=new fabric.Image(img,{left:100,top:100,scaleX:0.3,scaleY:0.3});f.metadata=seleccion;canvas.add(f).setActiveObject(f);addToBOM(seleccion);}catch{alert("Error cargando icono.");}});

    // BOM
    function addToBOM(item){const p=item.part;const car=`tipo:${item.tipo}, `+Object.entries(item).filter(([k])=>!["part","icon","tipo","precio"].includes(k)).map(([k,v])=>`${k}:${v}`).join(", ");const pr=parseFloat(item.precio)||0;if(!bomData[p])bomData[p]={caracteristicas:car,precio:pr,qty:0};bomData[p].qty++;refresh();}
    function refresh(){const list=document.getElementById("bomList");list.innerHTML="";Object.entries(bomData).forEach(([p,i])=>{const li=document.createElement("li");li.textContent=`${p} (x${i.qty})`;list.appendChild(li);});}
    document.getElementById("bomButton").addEventListener("click",()=>{const tb=document.querySelector("#bomTable tbody");tb.innerHTML="";let tot=0;Object.entries(bomData).forEach(([p,i])=>{const s=i.precio*i.qty;tot+=s;const tr=document.createElement("tr");tr.innerHTML=`<td>${p}</td><td>${i.caracteristicas}</td><td>${i.qty}</td><td>${i.precio.toFixed(2)}</td><td>${s.toFixed(2)}</td>`;tb.appendChild(tr);});document.getElementById("totalCell").innerText=tot.toFixed(2);document.getElementById("bomModal").style.display="flex";});
    function exportDetalle(){let csv="Part,Características,Cantidad,Precio,Subtotal\n";let t=0;Object.entries(bomData).forEach(([p,i])=>{const s=i.precio*i.qty;t+=s;csv+=`${p},"${i.caracteristicas}",${i.qty},${i.precio.toFixed(2)},${s.toFixed(2)}\n`;});csv+=`TOTAL,,,,${t.toFixed(2)}\n`;const blob=new Blob([csv],{type:"text/csv"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="Detalle.csv";a.click();}

    // Oferta PDF
    document.getElementById("crearOferta").addEventListener("click",()=>{document.getElementById("ofertaModal").style.display="flex";});
    async function generarPDF(){const {jsPDF}=window.jspdf;const d=new jsPDF();d.setFontSize(14);d.text("Oferta Comercial - Energia24-7",10,10);d.setFontSize(10);d.text("RUC: 1715486559",10,18);d.text("Dirección: Victor Mideros 39, Quito",10,24);d.text("Correo: fastindustrialsupply@gmail.com",10,30);d.setFontSize(12);d.text("Cliente:",10,42);d.setFontSize(10);d.text("Nombre: "+document.getElementById("cliNombre").value,10,50);let y=60;d.text("Contacto: "+document.getElementById("cliContacto").value,10,y);y+=6;d.text("Correo: "+document.getElementById("cliCorreo").value,10,y);y+=6;d.text("Teléfono: "+document.getElementById("cliTelefono").value,10,y);y+=6;d.text("Referencia: "+document.getElementById("cliRef").value,10,y);y+=10;d.setFontSize(12);d.text("Detalle de Materiales",10,y);y+=6;d.setFontSize(9);d.text("Part",10,y);d.text("Características",40,y);d.text("Cant",120,y);d.text("Precio",140,y);d.text("Subtotal",170,y);y+=4;let tot=0;Object.entries(bomData).forEach(([p,i])=>{const s=i.precio*i.qty;tot+=s;y+=6;d.text(p,10,y);d.text(i.caracteristicas.substring(0,60),40,y);d.text(i.qty.toString(),120,y);d.text(i.precio.toFixed(2),140,y);d.text(s.toFixed(2),170,y);});y+=10;const iva=tot*0.15;d.setFontSize(11);d.text("Subtotal: "+tot.toFixed(2),140,y);y+=6;d.text("IVA 15%: "+iva.toFixed(2),140,y);y+=6;d.text("TOTAL: "+(tot+iva).toFixed(2),140,y);d.save("Oferta_Energia24-7.pdf");document.getElementById("ofertaModal").style.display="none";}

    // Toggle panel
    document.getElementById("togglePanel").addEventListener("click",()=>{document.getElementById("rightPanel").classList.toggle("show");});
  </script>
</body>
</html>